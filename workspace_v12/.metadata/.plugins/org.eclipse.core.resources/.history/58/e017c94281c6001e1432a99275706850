#include <msp430.h>
#include <driverlib.h>
#include <Board.h>


void setupClock() {
    // Set system clock, assuming 1MHz DCO
    // Adjust as necessary for your specific MSP430 model
    BCSCTL1 = CALBC1_1MHZ;
    DCOCTL = CALDCO_1MHZ;
}

void setupPWM() {
    // Assuming P1.2 is connected to the fan controller
    P1DIR |= BIT2; // Set P1.2 to output direction
    P1SEL |= BIT2; // Select PWM function for P1.2

    // Configure Timer_A
    TACTL = TASSEL_2 + MC_1; // SMCLK as source, Up mode
    TACCR0 = 1000-1; // PWM Period, adjust for frequency
    TACCTL1 = OUTMOD_7; // Reset/Set mode
    TACCR1 = 750; // Initial duty cycle 75%
}

void setFanSpeed(unsigned int speed) {
    // Adjust duty cycle for speed control
    // 'speed' parameter is a percentage (0-100)
    // Ensure 'speed' does not exceed 100%
    if (speed > 100) speed = 100;
    TACCR1 = (TACCR0 + 1) * speed / 100 - 1;
}

int main(void) {
    WDTCTL = WDTPW + WDTHOLD; // Stop watchdog timer
    setupClock(); // Setup clock
    setupPWM(); // Setup PWM for fan control

    while(1) {
        // Example: Vary speed in a loop
        for(unsigned int speed = 0; speed <= 100; speed += 10) {
            setFanSpeed(speed); // Set fan speed
            __delay_cycles(1000000); // Delay
        }
    }
}


